#include "decompression.h"

char codeToChar(ArbreBin A, char* code){
  if(A == NULL){
    return 0;
  }
  else{
    if(strlen(code) == 0){
      return A->info;
    }
    else if (code[0] == '0'){
      return codeToChar(A->succG, code+1);
    }
    else{
      return codeToChar(A->succD, code+1);
    }
  }
}

char* IToChaineBin(int n){
  int reste = 0;
  if(n > 0){
    reste = n % 2;
    return concat(IToChaineBin(n/2), itoa(reste));
  }
  else{
    return "";
  }
}

void decompress(ArbreBin A, int debutText, char* fichier){
  FILE* fic = fopen(fichier,"r");
  
  if(fic == NULL){
    printf("ERREUR : Dans creerCode, ouverture fichier impossible\n");
    return; //impossible ouvrir fichier
  }
  
  for(int i = 0 ; i < debutText ; i++){
    fgetc(fic);
  }
  
  char carCourant = fgetc(fic);
  char* codeBin = IToChaineBin(carCourant);
  char* codeTmp = concat("", debutT(codeBin, 1));
  int tailleCodeBin = strlen(IToChaineBin(carCourant));

  printf("codeBin = %s\n", codeBin);
  printf("codeTmp = %s\n", codeTmp);
  
  while(carCourant != EOF){

    while(codeToChar(A, codeTmp) == 0 && tailleCodeBin > 0){
      codeBin = codeBin + 1;
      codeTmp = concat(codeTmp, debutT(codeBin, 1));
      tailleCodeBin--;
      printf("codeBin = %s\n", codeBin);
      printf("codeTmp = %s\n", codeTmp);
    }
    if(codeToChar(A, codeTmp) != 0){
      printf("%c", codeToChar(A, codeTmp));
    }
   
    carCourant = fgetc(fic);
    codeBin = concat(codeBin, IToChaineBin(carCourant));
  }
  fclose(fic);
}
