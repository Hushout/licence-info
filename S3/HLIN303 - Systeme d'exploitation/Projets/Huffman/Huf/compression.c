#include "compression.h"

char* charToCode(ArbreBin A, char c){
  if(A == NULL){
    return "";
  }
  else if (A->info == c){
    return "";
  }
  else if (estDans(A->succG, c)){
    return concat("0", charToCode(A->succG, c));
  }
  else {
    return concat("1", charToCode(A->succD, c));
  }
}

int chaineBinToI(char* chaineBin){
  if(chaineBin == NULL){
    printf("ERREUR : Dans chaineBinToI, Param NULL\n");
    return 0;
  }
  else{
    int res = 0;
    int taille = strlen(chaineBin);
    int k = taille -1;
  
    for(int i = 0 ; i < taille ; i++){
      char c = chaineBin[k];
      res += atoi(&c)*puiss(2, i);
      k--;
    }
    return res;
  }
}

void compress(ArbreBin A, char* fichier, char* destination){
  FILE* fic = fopen(fichier,"r");
  FILE* dest = fopen(destination,"ar+");
  
  if(fic == NULL){
    printf("ERREUR : Dans compress, ouverture fichier impossible\n");
    return; //impossible ouvrir fichier
  }

  if(dest == NULL){
    printf("ERREUR : Dans compress, ouverture fichier impossible\n");
    return; //impossible ouvrir fichier
  }

  char carCourant = fgetc(fic);
  char* TextBinaire = charToCode(A, carCourant);
  int textCompress = 0;

  while(carCourant != EOF){
 
    // printf("TextBinaire = %s\n", TextBinaire);
    while(strlen(TextBinaire) < 8){
      carCourant = fgetc(fic);
      TextBinaire = concat(TextBinaire, charToCode(A, carCourant));
    }
    
    if(strlen(TextBinaire) == 8){
      textCompress = chaineBinToI(TextBinaire);
      fputc(textCompress, dest);
      //printf("TextBinaire == 8 = %s\n", TextBinaire);
      TextBinaire = finT(TextBinaire, 8);
    }
    else{
      while(strlen(TextBinaire) > 8){
	textCompress = chaineBinToI(debutT(TextBinaire, 8));
	fputc(textCompress, dest);
	//printf("TextBinaire > 8 = %s\n", TextBinaire);
	TextBinaire = finT(TextBinaire, 8);
      }
    }
    carCourant = fgetc(fic);
  }
  fclose(fic);
  fclose(dest);
}

void parcourPrefCode(ArbreBin Rac, ArbreBin A, int* n){
  if(A != NULL){
    if(A->info == 0){
      parcourPrefCode(Rac, A->succG, n);
      parcourPrefCode(Rac, A->succD, n);
    }
    else{
      printf("%d codeChar(", *n);
      afficheChar(A->info);
      printf(") = %s\n", charToCode(Rac, A->info));
      *n = *n +1;
      parcourPrefCode(Rac, A->succG, n);
      parcourPrefCode(Rac, A->succD, n);
    }
  }
}

void parcourPrefixeCode(ArbreBin A){
  
  if(A != NULL){
    int n = 0;
    parcourPrefCode(A, A, &n);
  }
}
