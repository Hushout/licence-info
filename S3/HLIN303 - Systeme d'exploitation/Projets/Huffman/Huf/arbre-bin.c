#include "arbre-bin.h"

////////////////// AFFICHAGE /////////////////////////
//////////////////////////////////////////////////////

void parcourPrefixe(ArbreBin A){

  if(A != NULL){
    afficheN(*A);
    parcourPrefixe(A->succG);
    parcourPrefixe(A->succD);
  }
}

void afficheVal(ArbreBin A){

  if(A->info == 0){
    couleur(BLEU);
    printf("%f\n", A->freq);
  }
  else if(A->info == '\n'){
    couleur(VERT);
    printf("\\n | %f\n", A->freq);
  }
  else if(A->info == '\t'){
    couleur(VERT);
    printf("\\t | %f\n", A->freq);
  }
  else if(A->info == ' '){
    couleur(VERT);
    printf("' ' | %f\n", A->freq);
  }
  else{
    couleur(VERT);
    printf("%c | %f\n", A->info, A->freq);
  }
  couleur(NORMAL);
}

void afficheTbool(char* Tbool, int taille, int nbEspace){
  for(int i = 0 ; i < taille ; i++){
    char c = Tbool[i];
    if(atoi(&c) == 1){
      printf("│");
      espace(nbEspace);
    }
    else if(atoi(&c) == 0){
      espace(nbEspace+1);
    }
  } 
}

void affichePronfondeur(ArbreBin A, int profondeur, int estDernier, char* Tbool){
  if(A != NULL){
    
    if(profondeur > 0){
      afficheTbool(Tbool, profondeur-1, 3);
      if(!estDernier){
	printf("├── ");
      }
      else{
	printf("└── ");
	estDernier = 0;
      }
    }
    
    afficheVal(A);
    affichePronfondeur(A->succG, profondeur+1, estDernier, concat(Tbool, "1"));
    affichePronfondeur(A->succD, profondeur+1, !estDernier, concat(Tbool, "0"));
  }
}

void afficheA(ArbreBin A){
  affichePronfondeur(A, 0, 0, "");
}


//////////////// FONCTION ARBREBIN ///////////////////
//////////////////////////////////////////////////////


ArbreBin creerArbre(int info, float freq, ArbreBin succG, ArbreBin succD){

  ArbreBin A = malloc(sizeof(Noeud));
  A->info = info;
  A->freq = freq;
  A->succG = succG;
  A->succD = succD;
  return A;
}

ArbreBin copieDyn(ArbreBin A){
  if(A == NULL){
    return NULL;
  }
  else{
    return creerArbre(A->info, A->freq, copieDyn(A->succG), copieDyn(A->succD));
  }
}

ArbreBin creerArbreHuf(Noeud* TN, int taille){

  if(taille < 1){
    printf("Attention : TailleTN < 1\n"); 
    return NULL;
  }
  if(taille == 1){
    if(nbNoeud(TN) == 1){
      ArbreBin A = NULL;
      ArbreBin succD = copieDyn(&(TN[0]));
      A = creerArbre(0, TN[0].freq, NULL, succD);
      return A;
    }
    else{
      return TN;
    }
  }
  else{
    ArbreBin A = NULL;
    ArbreBin succG = copieDyn(&(TN[0]));
    ArbreBin succD = copieDyn(&(TN[1]));
    
    A = creerArbre(0, TN[0].freq + TN[1].freq, succG, succD);
    TN = queueTN(TN, &taille);
    TN[0] = *A;
    triCroisTN(TN, taille);
    return creerArbreHuf(TN, taille);
  }
}

int estDans(ArbreBin A, char c){
  return A == NULL ? 0 : A->info != c ? 0 || estDans(A->succG, c) || estDans(A->succD, c) : 1;
}

int estParfait(ArbreBin A){
  return A == NULL ? 1 : (nbNoeud(A->succG) == nbNoeud(A->succD)
  && estPuiss(nbNoeud(A)+1, 2) && (estParfait(A->succG) && estParfait(A->succD)));
}

int nbNoeud(ArbreBin A){
  return A == NULL ? 0 : nbNoeud(A->succG) + nbNoeud(A->succD) + 1;
}


//////////// FONCTION TABLEAU DE NOEUDS //////////////
//////////////////////////////////////////////////////


void afficheN(Noeud N){
  if(N.info == '\n'){
    printf("Car:\\n | code: %x | proba: %f\n", N.info, N.freq);
  }
  else if(N.info == '\t'){
    printf("Car:\\t | code: %x | proba: %f\n", N.info, N.freq);
  }
  else if(N.info == ' '){
    printf("Car:' '| code: %x | proba: %f\n", N.info, N.freq);
  }
  else{
    printf("Car: %c | code : %x | proba: %f\n", N.info, N.info, N.freq);
  }
}

void afficheTN(Noeud* TN, int taille){
  for(int i = 0 ; i < taille ; i++){
    printf("%i ", i);
    afficheN(TN[i]);
  }
}

Noeud* createTN(int taille){
  Noeud* TN = malloc(sizeof(Noeud)*taille);
  
  if(TN == NULL){
    printf("ERREUR : Dans createTN allocation memoire impossible\n");
    return NULL;
  }
  else{
    for(int i = 0 ; i < taille ; i++){
      TN[i].info = 0;
      TN[i].freq = 0;
      TN[i].succG = NULL;
      TN[i].succD = NULL;
    }
    return TN;
  }
}

int estDansTN(Noeud* TN, int c, int taille){
  
  if(TN == NULL){
    return 0;
  }
  else{
    int i = 0;
    while(i < taille){
      if(TN[i].info == c){
	return 1;
      }
      else{
	i++;
      }
    }
    return taille == 0 ? 0 : i != taille;
  }
}

void initInfoTN(Noeud* TN, char* fichier, int taille){

  if(TN == NULL){
    printf("ERREUR : Dans initInfoTN param NULL\n");
    return;
  }
  else{    
    FILE* fic = fopen(fichier,"r");
    int i = 0;
    
    if(fic == NULL){
      printf("ERREUR : Dans initInfoTN, ouverture fichier impossible\n");
      return; //impossible ouvrir fichier
    }

    int carCourant = fgetc(fic);
  
    while(carCourant != EOF){
      if(!estDansTN(TN, carCourant, taille) && i < taille){
	TN[i].info = carCourant;
	i++;
      }
      carCourant = fgetc(fic);
    }
    fclose(fic);

    return;
  }
}

void initFreqTN(Noeud* TN,  char* fichier, int taille){
  if(TN != NULL){
    for(int i = 0 ; i < taille ; i++){
      TN[i].freq = probCar(fichier, TN[i].info);
    }  
  }
}

void initTN(Noeud* TN, char* fichier, int taille){
  initInfoTN(TN, fichier, taille);
  initFreqTN(TN, fichier, taille);
}

void echangeN(Noeud* N1, Noeud* N2){
  Noeud N = *N1;
  *N1 = *N2;
  *N2 = N;
}

void triCroisTN(Noeud* TN, int taille){
  for(int i = 0 ; i < taille ; i++){
    for(int j = 0 ; j < taille-1 ; j++){
      if(TN[j].freq >= TN[j+1].freq){
	echangeN(&(TN[j]), &(TN[j+1]));
      }
    }
  }
}

Noeud* fileToTN(char* fichier, int* tailleTN){

  FILE* fic = fopen(fichier, "r");
  
  if(fic == NULL) {
    printf("ERREUR : Dans fileToTN, Ouverture de %s impossible\n", fichier);
  }
  
  int taille = nbCarDiff(fichier);
  Noeud* TN = createTN(taille);
  initTN(TN, fichier, taille);
  *tailleTN = taille;
  
  return TN;
}

Noeud* queueTN(Noeud* TN, int* tailleTN){
  if(*tailleTN < 1){
    return NULL;
  }
  else{
    *tailleTN = *tailleTN -1;
    return TN+1;
  }
}

void enregistrerTN(Noeud* TN, int tailleTN, int nbCarTot, char* fichier){

  FILE* fic = fopen(fichier,"w");
  
  if(fic == NULL){
    printf("ERREUR : Dans creerCode, ouverture fichier impossible\n");
    return; //impossible ouvrir fichier
  }

  for(int i = 0 ; i < tailleTN ; i++){
    fputc(TN[i].info, fic);
  }
  int nbOcc = 0;
  for(int i = 0 ; i < tailleTN ; i++){
    nbOcc = (int) nbCarTot*TN[i].freq;
    fputc(nbOcc, fic);
  }
  fclose(fic);
}

///probleme warning ici
Noeud* chargerTN(int tailleTN, char* fichier){

  FILE* fic = fopen(fichier,"r");

  if(fic == NULL){
    printf("ERREUR : Dans lireTN, ouverture fichier impossible\n");
    return NULL; //impossible ouvrir fichier
  }

  Noeud* TN = createTN(tailleTN);

  for(int i = 0 ; i < tailleTN ; i++){
    TN[i].info = fgetc(fic);
  }
  
  int* tabOcc = malloc(sizeof(int)*tailleTN);
  
  for(int i = 0 ; i < tailleTN ; i++){
    tabOcc[i] = fgetc(fic);
  }

  for(int i = 0 ; i < tailleTN ; i++){
    TN[i].freq = tabOcc[i]/((float)sommeTab(tabOcc, tailleTN));
  }
  free(tabOcc);
  fclose(fic);
  
  return TN;
}
